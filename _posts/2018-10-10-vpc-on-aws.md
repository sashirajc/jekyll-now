---
layout: post
title: Virtual Private Cloud on AWS
tags: AWS
---

VPC is a virtual data centre in the cloud.

Virtual Private Cloud is a logically isolated section of the AWS cloud where AWS resources can be launched in a private virtual network. There is complete control over the virtual networking environment including selection of own IP address ranges, creation of subnets, configuration of route tables and network gateways.

VPC consists of Internet gateways, route tables, network access control lists, subnets and security groups.

Security groups are stateful; network access control lists are stateless.

Systems architecture can be designed in such a way, that only webservers are placed in public facing subnets with internet access while databases and application servers are placed in private subnets with no internet access.

Hardware Virtual Private Network (VPN) connections can also be used between corporate datacenter and VPC and leverage AWS cloud as an extension of the corporate datacenter.

1 subnet = 1 availability zone

You can have 5 VPCs in a region, but this can be increased by contacting support.

cidr.xyz

Only one internet gateway can be attached to the VPC

Security groups can span multiple subnets.

Network ACLs can be used to block specific IP addresses.

Default VPC is
1.  user friendly and allows to deploy instances immediately.

2. All subnets are public and have access to the internet.

3. Each EC2 instance has a public and a private IP address while custom VPC instances will only get private IPs if they are on private subnets.

## VPC Peering

Allows to connect one VPC to another via direct network route.

Instance on one subnet inside a VPC can commmunicate with another subnet inside another VPC. The instances will then behave as if they were on the same private network.

VPC can be peered with other AWS accounts as well as VPCs on the same  account.

Peering is always in a star model. No transitive peering.

When a new VPC is created, a new route table, Network Access Control List and Security group are created.

When a subnet is created, number of IP addresses obtained will be 5 less than the total number of subnets. These are reserved by AWS for network, router, DNS, broadcast and future use

## Network Address Translation

### NAT Instances

When creating NAT instace, disable source/destination check on the instance

NAT instances must be in a public subnet

There must be a route out of the private subnet to the NAT instance

Amount of traffic that NAT instances can support depends on instance size.

NAt instances are behind a security group.

NAT instances can be configured with multi-az, auto scaling and other features available to EC2 instances.

### NAT Gateways

Prefereed by enterprises, scale automatically upto 10 Gbps. Fully managed and automatically assigned a public ip address.

More secure than NAT instance

## Network Access Control List

1 subnet can only be configured to 1 Network ACL

NACL cannot span VPC, they must be in one VPC. VPC automatically comes with a default NACL and by default allows all outbound and inbound traffic.

Custom NACL can be created. By default, they deny all inbound and outbound traffic until rules are added.

Each subnet in the VPC must be associated with a NACL. If not, the subnet is associated with the default NACL.

A NACL can be associated with multiple subnets, but a subnet can be associated with only one NACL at a time.

By default all inbound and outbound are denied on NACL

Google ephemeral ports on aws

NACL rules are applied numerically. So rule numbers with lower numbers will apply over rules with higher numbers. Once changes are made, they take effect immediately.

NACL can span az but subnet cannot

NACL have separate inbound and outbound rules, and each rule can allow or deny traffic. 

Design consideration while using a load balancer - VPC should have atleast 2 availability zones.

## VPC Flow Logs

A feature that enables to capture information about the IP traffic going to and from network interfaces in the VPC. Flow log data is stored using Amazon CloudWatch logs. After creating a flow log, they can be viewed and retrieved in CloudWatch.

Flow logs cannot be tagged.

Flow logs cannot be enabled for VPCs that are peered with another VPC unless both are in the same account.

After flow log is created, the configuration cannot be changed.

Not all traffic will be monitored. traffic generated by instances when they contact Amazon DNS or Windows license activation, or instance metadata or DHCP traffic will not be monitored.

## NAT vs Bastion

## VPC Endpoint

